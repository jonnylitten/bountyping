<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BountyPing - Bug Bounty Aggregator</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <header>
        <div class="container">
            <h1>ðŸŽ¯ BountyPing</h1>
            <p class="tagline">All bug bounty programs in one place</p>
        </div>
    </header>

    <div class="container">
        <!-- Stats -->
        <div class="stats" id="stats">
            <div class="stat">
                <span class="stat-value" id="stat-total">-</span>
                <span class="stat-label">Total Programs</span>
            </div>
            <div class="stat">
                <span class="stat-value" id="stat-new">-</span>
                <span class="stat-label">New This Week</span>
            </div>
            <div class="stat">
                <span class="stat-value" id="stat-paid">-</span>
                <span class="stat-label">Paid Programs</span>
            </div>
            <div class="stat">
                <span class="stat-value" id="stat-platforms">-</span>
                <span class="stat-label">Platforms</span>
            </div>
        </div>

        <!-- Filters -->
        <div class="filters">
            <input
                type="text"
                id="search"
                placeholder="Search programs..."
                class="search-input"
            >

            <select id="platform" class="filter-select">
                <option value="">All Platforms</option>
            </select>

            <select id="sort" class="filter-select">
                <option value="newest">Newest First</option>
                <option value="bounty">Highest Bounty</option>
                <option value="name">Alphabetical</option>
            </select>

            <label class="checkbox-label">
                <input type="checkbox" id="bounties-only">
                Paid Programs Only
            </label>

            <label class="checkbox-label">
                <input type="checkbox" id="new-only">
                New This Week
            </label>
        </div>

        <!-- Results count -->
        <div class="results-info">
            <span id="results-count">Loading...</span>
        </div>

        <!-- Programs list -->
        <div id="programs" class="programs-list">
            <div class="loading">Loading programs...</div>
        </div>
    </div>

    <footer>
        <div class="container">
            <p>BountyPing - Aggregating bug bounty programs from across the web</p>
            <p class="footer-note">Data sourced from public directories. Always verify on official platforms.</p>
        </div>
    </footer>

    <script>
        // State
        let allPrograms = [];
        let platforms = [];

        // DOM elements
        const programsContainer = document.getElementById('programs');
        const searchInput = document.getElementById('search');
        const platformSelect = document.getElementById('platform');
        const sortSelect = document.getElementById('sort');
        const bountiesOnlyCheckbox = document.getElementById('bounties-only');
        const newOnlyCheckbox = document.getElementById('new-only');
        const resultsCount = document.getElementById('results-count');

        // Fetch and display stats
        async function loadStats() {
            try {
                const response = await fetch('/api/stats');
                const stats = await response.json();

                document.getElementById('stat-total').textContent = stats.total_programs.toLocaleString();
                document.getElementById('stat-new').textContent = stats.new_this_week.toLocaleString();
                document.getElementById('stat-paid').textContent = stats.paid_programs.toLocaleString();
                document.getElementById('stat-platforms').textContent = stats.platforms;
            } catch (error) {
                console.error('Failed to load stats:', error);
            }
        }

        // Fetch platforms for filter
        async function loadPlatforms() {
            try {
                const response = await fetch('/api/platforms');
                const data = await response.json();
                platforms = data.platforms;

                // Populate platform dropdown
                platforms.forEach(platform => {
                    const option = document.createElement('option');
                    option.value = platform.name;
                    option.textContent = `${platform.name} (${platform.count})`;
                    platformSelect.appendChild(option);
                });
            } catch (error) {
                console.error('Failed to load platforms:', error);
            }
        }

        // Fetch programs with current filters
        async function loadPrograms() {
            const params = new URLSearchParams();

            if (searchInput.value) params.set('search', searchInput.value);
            if (platformSelect.value) params.set('platform', platformSelect.value);
            if (sortSelect.value) params.set('sort_by', sortSelect.value);
            if (bountiesOnlyCheckbox.checked) params.set('bounties_only', 'true');
            if (newOnlyCheckbox.checked) params.set('new_only', 'true');

            try {
                const response = await fetch(`/api/programs?${params}`);
                const data = await response.json();

                allPrograms = data.programs;
                displayPrograms(allPrograms);
                resultsCount.textContent = `${data.count} program${data.count !== 1 ? 's' : ''}`;
            } catch (error) {
                console.error('Failed to load programs:', error);
                programsContainer.innerHTML = '<div class="error">Failed to load programs</div>';
            }
        }

        // Display programs in the UI
        function displayPrograms(programs) {
            if (programs.length === 0) {
                programsContainer.innerHTML = '<div class="no-results">No programs found</div>';
                return;
            }

            programsContainer.innerHTML = programs.map(program => {
                const isNew = program.first_seen &&
                    (new Date() - new Date(program.first_seen)) < 7 * 24 * 60 * 60 * 1000;

                const bountyText = program.vdp_only ?
                    'No bounty (VDP)' :
                    (program.bounty_max ?
                        `$${program.bounty_min || 0} - $${program.bounty_max.toLocaleString()}` :
                        'Bounty available');

                return `
                    <div class="program-card ${isNew ? 'new-program' : ''}">
                        ${isNew ? '<span class="new-badge">NEW</span>' : ''}

                        <div class="program-header">
                            <h3 class="program-name">
                                <a href="${program.url}" target="_blank" rel="noopener">${program.name}</a>
                            </h3>
                            <span class="platform-badge">${program.platform}</span>
                        </div>

                        <div class="program-details">
                            <div class="detail">
                                <span class="detail-label">Bounty:</span>
                                <span class="detail-value ${program.vdp_only ? 'vdp' : 'bounty'}">${bountyText}</span>
                            </div>

                            ${program.asset_types && program.asset_types.length > 0 ? `
                                <div class="detail">
                                    <span class="detail-label">Types:</span>
                                    <span class="detail-value">${program.asset_types.join(', ')}</span>
                                </div>
                            ` : ''}

                            ${program.assets && program.assets.length > 0 ? `
                                <div class="detail">
                                    <span class="detail-label">Scope:</span>
                                    <span class="detail-value scope-preview">
                                        ${program.assets.slice(0, 3).join(', ')}
                                        ${program.assets.length > 3 ? ` (+${program.assets.length - 3} more)` : ''}
                                    </span>
                                </div>
                            ` : ''}
                        </div>

                        <div class="program-footer">
                            <a href="${program.url}" target="_blank" rel="noopener" class="view-link">
                                View Program â†’
                            </a>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Event listeners
        searchInput.addEventListener('input', debounce(loadPrograms, 300));
        platformSelect.addEventListener('change', loadPrograms);
        sortSelect.addEventListener('change', loadPrograms);
        bountiesOnlyCheckbox.addEventListener('change', loadPrograms);
        newOnlyCheckbox.addEventListener('change', loadPrograms);

        // Debounce helper
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Initialize
        loadStats();
        loadPlatforms();
        loadPrograms();
    </script>
</body>
</html>
